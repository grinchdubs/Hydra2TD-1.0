<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hydra in TouchDesigner (Local)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: black;
            overflow: hidden;
        }
        canvas {
            display: block;
            width: 100vw !important;
            height: 100vh !important;
        }
        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            color: lime;
            font-family: monospace;
            font-size: 12px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="debug">Loading Hydra from local file...</div>

    <!-- Load Hydra from local file -->
    <script src="file:///C:/Users/cuban/HydraToTD/html/hydra-synth.js"></script>

    <script>
        console.log("Script started");

        // Debug logging
        function log(msg) {
            console.log(msg);
            const debug = document.getElementById('debug');
            if (debug) {
                debug.innerHTML += '<br>' + msg;
            }
        }

        // Small delay to ensure Hydra loads
        setTimeout(function() {
            try {
                log("Checking Hydra...");

                if (typeof Hydra === 'undefined') {
                    log("ERROR: Hydra not loaded from local file!");
                    log("Check: file:///C:/Users/cuban/HydraToTD/html/hydra-synth.js");
                } else {
                    log("✓ Hydra loaded from local file!");

                    // Initialize Hydra
                    log("Initializing Hydra...");
                    const hydra = new Hydra({
                        detectAudio: false,
                        enableStreamCapture: false,
                        makeGlobal: true
                    });

                    log("✓ Hydra initialized!");

                    // Global data store for TouchDesigner data
                    window.tdData = {
                        chops: {},
                        timestamp: Date.now(),
                        updateCount: 0
                    };

                    // Performance monitoring
                    window.tdPerformance = {
                        fps: 60,
                        frameTime: 0,
                        lastUpdate: Date.now(),
                        chopUpdateRate: 0
                    };

                    let frameCount = 0;
                    let lastTime = Date.now();
                    let lastChopUpdate = Date.now();

                    function updatePerformance() {
                        frameCount++;
                        const now = Date.now();
                        const elapsed = now - lastTime;

                        if (elapsed >= 1000) {
                            window.tdPerformance.fps = (frameCount / elapsed) * 1000;
                            window.tdPerformance.frameTime = elapsed / frameCount;
                            frameCount = 0;
                            lastTime = now;
                        }

                        requestAnimationFrame(updatePerformance);
                    }

                    updatePerformance();

                    // Update function called from TouchDesigner
                    window.updateFromTD = function(jsonData) {
                        try {
                            const data = JSON.parse(jsonData);
                            window.tdData.chops = data;
                            window.tdData.timestamp = Date.now();
                            window.tdData.updateCount++;

                            // Calculate CHOP update rate
                            const now = Date.now();
                            const chopElapsed = now - lastChopUpdate;
                            if (chopElapsed > 0) {
                                window.tdPerformance.chopUpdateRate = 1000 / chopElapsed;
                            }
                            lastChopUpdate = now;
                        } catch(e) {
                            console.error('Parse error:', e);
                        }
                    };

                    // CHOP accessor function for Hydra code
                    window.chop = function(name, index) {
                        return function() {
                            if (window.tdData.chops[name] && window.tdData.chops[name][index] !== undefined) {
                                return window.tdData.chops[name][index];
                            }
                            return 0;
                        };
                    };

                    // Shorthand LFO accessor
                    window.lfo = function(index) {
                        return chop('lfo' + index, 0);
                    };

                    // MIDI accessor
                    window.midi = function(cc) {
                        return chop('midi', cc);
                    };

                    // Audio FFT from TD analysis
                    window.audioFFT = function(index) {
                        return chop('audio_spectrum', index);
                    };

                    // Execute Hydra code sent from TouchDesigner
                    window.runHydraCode = function(code) {
                        try {
                            eval(code);
                            log("Code executed successfully");
                        } catch(e) {
                            console.error('Hydra execution error:', e);
                            log("ERROR: " + e.message);
                        }
                    };

                    // Set which output buffer to render
                    window.setOutput = function(index) {
                        try {
                            const buffer = eval('o' + index);
                            render(buffer);
                        } catch(e) {
                            console.error('Output error:', e);
                        }
                    };

                    // Get performance metrics
                    window.getPerformance = function() {
                        return JSON.stringify(window.tdPerformance);
                    };

                    // Initialize video stream
                    window.registerVideoStream = function(url) {
                        try {
                            s0.initStream(url);
                            log('Video stream initialized: ' + url);
                        } catch(e) {
                            console.error('Stream error:', e);
                        }
                    };

                    // Initialize webcam
                    window.initWebcam = function() {
                        try {
                            s0.initCam();
                            log('Webcam initialized');
                        } catch(e) {
                            console.error('Webcam error:', e);
                        }
                    };

                    // Clear all outputs
                    window.clearAll = function() {
                        solid(0).out(o0);
                        solid(0).out(o1);
                        solid(0).out(o2);
                        solid(0).out(o3);
                    };

                    log("✓ Helper functions created");

                    // Test pattern - bright red first
                    log("Running test pattern...");
                    solid(1, 0, 0).out();

                    setTimeout(() => {
                        log("Switching to oscillator...");
                        osc(10, 0.1, 1.4).out();
                    }, 1000);

                    log("✓ READY! You should see RED then oscillator");

                    // Hide debug after 5 seconds
                    setTimeout(() => {
                        const debug = document.getElementById('debug');
                        if (debug) debug.style.display = 'none';
                    }, 5000);
                }

            } catch(error) {
                log("FATAL ERROR: " + error.message);
                console.error("Fatal error:", error);
            }
        }, 100); // 100ms delay to ensure script loads

        console.log('Hydra-TouchDesigner initialized!');
        console.log('Available functions: chop(), lfo(), midi(), audioFFT()');
    </script>
</body>
</html>
