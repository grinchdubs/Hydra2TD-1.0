<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hydra in TouchDesigner</title>
    <style>
        body { margin: 0; padding: 0; background: black; overflow: hidden; }
        canvas { display: block; width: 100vw !important; height: 100vh !important; }
    </style>
</head>
<body>
    <script>HYDRA_SCRIPT_PLACEHOLDER</script>
    <script>
        console.log("Hydra script loaded");

        setTimeout(function() {
            try {
                if (typeof Hydra === 'undefined') {
                    console.error("Hydra not defined!");
                } else {
                    console.log("Initializing Hydra...");
                    const hydra = new Hydra({ detectAudio: false, makeGlobal: true });
                    console.log("Hydra initialized!");

                    // Global data store for TouchDesigner
                    window.tdData = { chops: {}, timestamp: Date.now(), updateCount: 0 };
                    window.tdPerformance = { fps: 60, frameTime: 0, lastUpdate: Date.now(), chopUpdateRate: 0 };

                    let frameCount = 0, lastTime = Date.now(), lastChopUpdate = Date.now();

                    function updatePerformance() {
                        frameCount++;
                        const now = Date.now(), elapsed = now - lastTime;
                        if (elapsed >= 1000) {
                            window.tdPerformance.fps = (frameCount / elapsed) * 1000;
                            window.tdPerformance.frameTime = elapsed / frameCount;
                            frameCount = 0; lastTime = now;
                        }
                        requestAnimationFrame(updatePerformance);
                    }
                    updatePerformance();

                    window.updateFromTD = function(jsonData) {
                        try {
                            const data = JSON.parse(jsonData);
                            window.tdData.chops = data;
                            window.tdData.timestamp = Date.now();
                            window.tdData.updateCount++;
                            const now = Date.now(), chopElapsed = now - lastChopUpdate;
                            if (chopElapsed > 0) window.tdPerformance.chopUpdateRate = 1000 / chopElapsed;
                            lastChopUpdate = now;
                        } catch(e) { console.error('Parse error:', e); }
                    };

                    window.chop = function(name, index) {
                        return function() {
                            return (window.tdData.chops[name] && window.tdData.chops[name][index] !== undefined)
                                ? window.tdData.chops[name][index] : 0;
                        };
                    };

                    window.lfo = function(index) { return chop('lfo' + index, 0); };
                    window.midi = function(cc) { return chop('midi', cc); };
                    window.audioFFT = function(index) { return chop('audio_spectrum', index); };

                    window.runHydraCode = function(code) {
                        try {
                            eval(code);
                            console.log("Code executed successfully");
                        } catch(e) {
                            console.error('Hydra error:', e);
                        }
                    };

                    window.setOutput = function(index) {
                        try { render(eval('o' + index)); }
                        catch(e) { console.error('Output error:', e); }
                    };

                    window.getPerformance = function() { return JSON.stringify(window.tdPerformance); };

                    window.registerVideoStream = function(url) {
                        try { s0.initStream(url); console.log('Video stream: ' + url); }
                        catch(e) { console.error('Stream error:', e); }
                    };

                    window.initWebcam = function() {
                        try { s0.initCam(); console.log('Webcam initialized'); }
                        catch(e) { console.error('Webcam error:', e); }
                    };

                    window.clearAll = function() {
                        solid(0).out(o0); solid(0).out(o1); solid(0).out(o2); solid(0).out(o3);
                    };

                    console.log("Helper functions created");
                    console.log("Hydra-TouchDesigner ready!");
                    console.log("Waiting for CodeManager to send code...");

                    // Default: solid black (waiting for code from TD)
                    solid(0).out();
                }
            } catch(error) {
                console.error("Fatal error:", error);
            }
        }, 100);
    </script>
</body>
</html>
